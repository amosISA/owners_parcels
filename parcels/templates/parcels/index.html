{% extends "parcels/base.html" %}

{% block content %}

<div class="row form-check-parcel">
    <div class="form-parcel-input">
        <label for="inputPoligono">Polígono</label>
        <input type="text" id="inputPoligono">
    </div>
    <div class="form-parcel-input">
        <label for="inputParcela">Parcela</label>
        <input type="text" id="inputParcela">
    </div>
    <div class="form-parcel-input">
        <label style="color:#fff;">.</label>
        <button class="formButtonCheckParcela">Comprobar</button>
    </div>
</div>

<div class="row">
    <div class="col-md-9" id="map_canvas">
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item active">Proyectos</li>
                </ol>
                <ul>
                    {% for proyecto in proyectos %}
                        <li>
                            <a class="project-name" data-id="{{ proyecto.id }}" href="#">
                                - {{ proyecto.nombre }}
                            </a>
                            <ul>
                                {% for sector in proyecto.sector_trabajo.all %}
                                    <li>{{ sector }}</li>
                                    <ul>
                                        {% for parcela in sector.parcela.all %}
                                            <li>{{ parcela }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endfor %}
                            </ul>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="parcels-list">

            </div>
        </div>

        <table width="100%">
            <thead>
                <tr>
                    <!--<th>Polígono</th>
                    <th>Parcela</th>-->
                </tr>
            </thead>
            <tbody>
                {% for parcela in parcelas %}
                    <tr>
                        <td>{{ parcela.poligono }}</td>
                        <td>
                            <input class="parcela-google-maps-checkbox" type="checkbox" data-parcela="{{ parcela.numero_parcela }}" data-poligono="{{ parcela.poligono }}">
                            {{ parcela.numero_parcela }}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block js %}
    <script>
        $(document).ready(function() {
            $('#tabla_parcelas').DataTable({
                "language": {
                    url: "/static/parcels/location/es_ES.json"
                }
            });

            /****** AJAX FOR RIGHT SIDE *****/
            // If i dont do it by on, this wont work, the on is for future elements,
            // this is: proj-breadcrumb anchors created after in card for clicking callback
            // WHEN YOU CLICK ON PROJECTS ON BREADCRUMBS
            var card = $('.card');
            card.on("click", ".proj-breadcrumb", function() {
                $.ajax({
                    method: 'GET',
                    url: '{% url "parcels:ajax_get_proyectos" %}',
                    data: {
                    },
                    dataType: 'json',
                    success: function (data) {
                        var success_div = $('.card .card-header');
                        var li_proj;
                        success_div.html('');
                        success_div.html('<ol class="breadcrumb">' +
                                            '<li class="breadcrumb-item active">Proyectos</li>' +
                                         '</ol>');

                        $.each(data, function(key, value) {
                            success_div.append('<li><a class="project-name" data-id="' + value.pk + '" href="#">' + value.fields['nombre'] + '</a></li>');
                        });
                    }
                });
            });

            // WHEN YOU CLICK ON EACH PROJECTS TO SWITCH TO SECTORES
            card.on('click', '.project-name', function() {
                $.ajax({
                    method: 'GET',
                    url: '{% url "parcels:ajax_get_sectores" %}',
                    data: {
                        'project_name': $(this).attr('data-id')
                    },
                    dataType: 'json',
                    success: function (data) {
                        var success_div = $('.card .card-header');
                        success_div.html('');
                        success_div.html('<ol class="breadcrumb"><li class="breadcrumb-item"><a href="#" class="proj-breadcrumb">Proyectos</a></li><li class="breadcrumb-item active">Sectores</li></ol>');

                        $.each(data, function(key, value) {
                            success_div.append('<li><a href="#">' + value.fields['sector'] + '</a></li>');
                        });
                    }
                });
            });
        } );

        function pad (str, max) {
            str = str.toString();
            return str.length < max ? pad("0" + str, max) : str;
        }

        var layers = [];
        var layersForm = [];
        var map;

        $('.parcela-google-maps-checkbox').change(function(){
            var polig = parseInt($(this).attr('data-poligono'));
            var parc = parseInt($(this).attr('data-parcela'));
            if($(this).is(':checked')) {
                layers[parc] = new google.maps.KmlLayer({
                    url: 'https://ovc.catastro.meh.es/Cartografia/WMS/BuscarParcelaGoogle3D.aspx?refcat=03127A'+ pad(polig, 3) + pad(parc, 5) + '0000BP&del=3&mun=127&tipo=3d',
                    suppressInfoWindows: false
                    //preserveViewport: true
                });

                if (layers[parc].getMap() == null) {
                    layers[parc].setMap(map);
                } else {
                    layers[parc].setMap(null);
                }
            } else {
                if (layers[parc].getMap() == null) {
                    layers[parc].setMap(map);
                } else {
                    layers[parc].setMap(null);
                }
            }
        });

        $('.formButtonCheckParcela').click(function() {
            var inputPolig = $('#inputPoligono').val();
            var inputParc = $('#inputParcela').val();
            //console.log(layersForm);

            $.each(layersForm, function(i,v){
                if (v instanceof Object) {
                    layersForm[i].setMap(null);
                }
                //console.log(i + ' ' + v instanceof Object);
            });

            layersForm[inputParc] = new google.maps.KmlLayer({
                url: 'https://ovc.catastro.meh.es/Cartografia/WMS/BuscarParcelaGoogle3D.aspx?refcat=03127A'+ pad(inputPolig, 3) + pad(inputParc, 5) + '0000BP&del=3&mun=127&tipo=3d',
                suppressInfoWindows: false
            });

            layersForm[inputParc].setMap(map);
        });

        function initialize(){
            var myOptions = {
                zoom: 11,
                center: {lat: 38.691351, lng: -0.100658},
                mapTypeId: google.maps.MapTypeId.SATELLITE
            };
            map = new google.maps.Map(document.getElementById('map_canvas'), myOptions);
        }

        google.maps.event.addDomListener(window, 'load', initialize);
    </script>
{% endblock %}